
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MPipe cookbook &mdash; MPipe Documentation</title>
    
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="MPipe Documentation" href="index.html" />
    <link rel="next" title="Examples" href="examples.html" />
    <link rel="prev" title="Pipeline concepts" href="concepts.html" />
 
    <style type="text/css">
      
    </style>

  </head>
  <body>
<div class="pageheader">
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="docs.html">Docs</a></li>
    <li><a href="api.html">API</a></li>
    <li><a href="about.html">About</a></li>
  </ul>
  <div>
    <a href="index.html">
      <img src="_static/mpipe.png" alt="Da logo, man." />
    </a>
  </div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Examples"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="concepts.html" title="Pipeline concepts"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">MPipe home</a>&nbsp;|</li>
  <li><a href="docs.html">Documentation</a> &raquo;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>API Search</h3>
  
  <form class="search" action="search.html" method="get">
<!--
    <div class="search-input">
      <input type="text" name="q" />
    </div>
    <div class="search-go">
      <input type="submit" value="Go" />
    </div>
-->
      <input class="search-input" type="text" name="q" />
      <input class="search-go" type="submit" value="Go" />

    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
  
  <p class="searchtip">
    Search the MPipe module for classes and functions.
  </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="name-cookbook">
<span id="operation"></span><h1>MPipe cookbook<a class="headerlink" href="#name-cookbook" title="Permalink to this headline">¶</a></h1>
<p>A pipeline algorithm is implemented using classes from the <a class="reference internal" href="api.html#module-mpipe" title="mpipe"><tt class="xref py py-mod docutils literal"><span class="pre">mpipe</span></tt></a> module. Elements of the pipeline framework map to specific Python objects:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Framework element</th>
<th class="head">Python construct</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>task</em>, <em>result</em></td>
<td>any Python picklable object</td>
</tr>
<tr class="row-odd"><td><em>worker</em></td>
<td>single-argument function,
<a class="reference internal" href="api.html#mpipe.OrderedWorker" title="mpipe.OrderedWorker"><tt class="xref py py-mod docutils literal"><span class="pre">OrderedWorker</span></tt></a> or
<a class="reference internal" href="api.html#mpipe.UnorderedWorker" title="mpipe.UnorderedWorker"><tt class="xref py py-mod docutils literal"><span class="pre">UnorderedWorker</span></tt></a></td>
</tr>
<tr class="row-even"><td><em>stage</em></td>
<td><a class="reference internal" href="api.html#mpipe.Stage" title="mpipe.Stage"><tt class="xref py py-mod docutils literal"><span class="pre">Stage</span></tt></a>,
<a class="reference internal" href="api.html#mpipe.OrderedStage" title="mpipe.OrderedStage"><tt class="xref py py-mod docutils literal"><span class="pre">OrderedStage</span></tt></a> or
<a class="reference internal" href="api.html#mpipe.UnorderedStage" title="mpipe.UnorderedStage"><tt class="xref py py-mod docutils literal"><span class="pre">UnorderedStage</span></tt></a></td>
</tr>
<tr class="row-odd"><td><em>pipeline</em></td>
<td><a class="reference internal" href="api.html#mpipe.Pipeline" title="mpipe.Pipeline"><tt class="xref py py-mod docutils literal"><span class="pre">Pipeline</span></tt></a></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>It may be useful to keep in mind that MPipe is built using classes from Python&#8217;s standard <a class="reference external" href="http://docs.python.org/library/multiprocessing.html#multiprocessing" title="(in Python v2.7)"><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> module. One may think of it as a layer on top, encapsulating classes like <a class="reference external" href="http://docs.python.org/library/multiprocessing.html#multiprocessing.Process" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a>, <a class="reference external" href="http://docs.python.org/library/multiprocessing.html#multiprocessing.Queue" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> and <a class="reference external" href="http://docs.python.org/library/multiprocessing.html#multiprocessing.Connection" title="(in Python v2.7)"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a> with behavior specific to the pipeline framework.</p>
<p>The procedure of building and running a pipeline is a sequence of five steps:</p>
<blockquote>
<div><ol class="arabic simple">
<li><a class="reference internal" href="#define-workers"><em>define workers</em></a></li>
<li><a class="reference internal" href="#create-stage-objects"><em>create stage objects</em></a></li>
<li><a class="reference internal" href="#link-the-stages"><em>link the stages</em></a></li>
<li><a class="reference internal" href="#create-pipeline-object"><em>create pipeline object</em></a></li>
<li><a class="reference internal" href="#operate-the-pipeline"><em>operate the pipeline</em></a></li>
</ol>
</div></blockquote>
<div class="section" id="define-workers">
<span id="id1"></span><h2>1. Define workers<a class="headerlink" href="#define-workers" title="Permalink to this headline">¶</a></h2>
<p>Start by defining the work that will be performed by individual workers of your stages. The easiest way is to write a function that takes a single <em>task</em> parameter:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">doSomething</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
   <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>The function&#8217;s return value becomes result of the stage. If it doesn&#8217;t return anything (or <tt class="docutils literal"><span class="pre">None</span></tt>), then the stage is considered a dead-end stage, not producing any output.</p>
<p>The other way is to subclass from <a class="reference internal" href="api.html#mpipe.OrderedWorker" title="mpipe.OrderedWorker"><tt class="xref py py-mod docutils literal"><span class="pre">OrderedWorker</span></tt></a> or <a class="reference internal" href="api.html#mpipe.UnorderedWorker" title="mpipe.UnorderedWorker"><tt class="xref py py-mod docutils literal"><span class="pre">UnorderedWorker</span></tt></a> and put the actual work inside the <tt class="xref py py-meth docutils literal"><span class="pre">doTask()</span></tt> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">mpipe</span><span class="o">.</span><span class="n">OrderedWorker</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">doTask</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Just like when using a standalone function, stage result can be the return value. Another way is to call <tt class="xref py py-meth docutils literal"><span class="pre">putResult()</span></tt>. This can be useful if you want your worker to continue processing after registering the stage result:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyWorker</span><span class="p">(</span><span class="n">mpipe</span><span class="o">.</span><span class="n">OrderedWorker</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">doTask</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">putResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
      <span class="c"># Do some more stuff.</span>
</pre></div>
</div>
</div>
<div class="section" id="create-stage-objects">
<span id="id2"></span><h2>2. Create stage objects<a class="headerlink" href="#create-stage-objects" title="Permalink to this headline">¶</a></h2>
<p>Having defined your workers, the next step is to instantiate stage objects. With standalone work functions, the stage is created with <a class="reference internal" href="api.html#mpipe.OrderedStage" title="mpipe.OrderedStage"><tt class="xref py py-mod docutils literal"><span class="pre">OrderedStage</span></tt></a> or <a class="reference internal" href="api.html#mpipe.UnorderedStage" title="mpipe.UnorderedStage"><tt class="xref py py-mod docutils literal"><span class="pre">UnorderedStage</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stage1</span> <span class="o">=</span> <span class="n">mpipe</span><span class="o">.</span><span class="n">OrderedStage</span><span class="p">(</span><span class="n">doSomething</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>When using worker classes, create a <a class="reference internal" href="api.html#mpipe.Stage" title="mpipe.Stage"><tt class="xref py py-mod docutils literal"><span class="pre">Stage</span></tt></a> object instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stage2</span> <span class="o">=</span> <span class="n">mpipe</span><span class="o">.</span><span class="n">Stage</span><span class="p">(</span><span class="n">MyWorker</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>In both cases the second argument is the number of processes devoted to the particular stage.</p>
</div>
<div class="section" id="link-the-stages">
<span id="id3"></span><h2>3. Link the stages<a class="headerlink" href="#link-the-stages" title="Permalink to this headline">¶</a></h2>
<p>If there are multiple stages in the workflow, they can be linked together:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stage1</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">stage2</span><span class="p">)</span>
</pre></div>
</div>
<p>Output of one stage may be forked into multiple downstream stages, splitting the workflow into parallel streams of execution:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stage1</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">stage2</span><span class="p">)</span>
<span class="n">stage1</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">stage3</span><span class="p">)</span>
<span class="n">stage1</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">stage4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="create-pipeline-object">
<span id="id4"></span><h2>4. Create pipeline object<a class="headerlink" href="#create-pipeline-object" title="Permalink to this headline">¶</a></h2>
<p>A pipeline is created by passing the root upstream stage to the <a class="reference internal" href="api.html#mpipe.Pipeline" title="mpipe.Pipeline"><tt class="xref py py-mod docutils literal"><span class="pre">Pipeline</span></tt></a> constructor:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pipe</span> <span class="o">=</span> <span class="n">mpipe</span><span class="p">(</span><span class="n">stage1</span><span class="p">)</span>
</pre></div>
</div>
<p>Once built, the pipeline has allocated and started all designated processes. At this point the pipeline is waiting for input, its worker processes idle and ready.</p>
</div>
<div class="section" id="operate-the-pipeline">
<span id="id5"></span><h2>5. Operate the pipeline<a class="headerlink" href="#operate-the-pipeline" title="Permalink to this headline">¶</a></h2>
<p>From this point on, operating the pipeline is solely accomplished by manipulating the <a class="reference internal" href="api.html#mpipe.Pipeline" title="mpipe.Pipeline"><tt class="xref py py-mod docutils literal"><span class="pre">Pipeline</span></tt></a> object. Input tasks are fed using <a class="reference internal" href="api.html#mpipe.Pipeline.put" title="mpipe.Pipeline.put"><tt class="xref py py-meth docutils literal"><span class="pre">put()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pipe</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">something</span><span class="p">)</span>
</pre></div>
</div>
<p>Output results, if any, are fetched using <a class="reference internal" href="api.html#mpipe.Pipeline.get" title="mpipe.Pipeline.get"><tt class="xref py py-meth docutils literal"><span class="pre">get()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">result</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>Alternatively, one can iterate the output stream with <a class="reference internal" href="api.html#mpipe.Pipeline.results" title="mpipe.Pipeline.results"><tt class="xref py py-meth docutils literal"><span class="pre">results()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pipe</span><span class="o">.</span><span class="n">results</span><span class="p">():</span>
   <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>At some point in manipulating the pipeline, the special task <tt class="docutils literal"><span class="pre">None</span></tt> should be put on it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pipe</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>This signals the end of input stream and eventually terminates all worker processes, effectively &#8220;closing&#8221; the pipeline to further input.</p>
<p>The <tt class="docutils literal"><span class="pre">None</span></tt> task can be thought of as a &#8220;stop&#8221; request. It becomes part of the sequence of input tasks streaming into the pipeline and, like other tasks, it propagates through all stages. However, it is processed in a special way: when it arrives at a stage, it signals all worker processes within to complete any current task they may be running, and to terminate execution. Before the last worker terminates, it propagates the &#8220;stop&#8221; request to the next downstram stage (or stages, if forked.)</p>
<p>The <tt class="docutils literal"><span class="pre">None</span></tt> task should be the last input to the pipeline. After it is added to the stream of tasks, the pipeline continues to process any previous tasks still in the system. After worker processes terminate, results can still be accesses in the usual way (using <a class="reference internal" href="api.html#mpipe.Pipeline.get" title="mpipe.Pipeline.get"><tt class="xref py py-meth docutils literal"><span class="pre">get()</span></tt></a> or <a class="reference internal" href="api.html#mpipe.Pipeline.results" title="mpipe.Pipeline.results"><tt class="xref py py-meth docutils literal"><span class="pre">results()</span></tt></a>) until the pipeline is emptied. However, any &#8220;real&#8221; task (i.e. not <tt class="docutils literal"><span class="pre">None</span></tt>) put on the pipeline following the &#8220;stop&#8221; request will not be processed.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Examples"
             >next</a> |</li>
        <li class="right" >
          <a href="concepts.html" title="Pipeline concepts"
             >previous</a> |</li>
  <li><a href="index.html">MPipe home</a>&nbsp;|</li>
  <li><a href="docs.html">Documentation</a> &raquo;</li>
 
      </ul>
    </div>
  
    <div class="footer">
        &copy; Copyright 2013, Velimir Mlaker.
      Last updated on Jun 17, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>

  </body>
</html>